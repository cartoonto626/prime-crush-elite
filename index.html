<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PRIME CRUSH ELITE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; touch-action: none; overflow: hidden; }
        #game-ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .info-bar { position: absolute; top: 10px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; font-size: 1.2rem; }
        #input-panel { position: absolute; bottom: 140px; width: 100%; display: flex; justify-content: center; gap: 10px; pointer-events: auto; flex-wrap: wrap; padding: 0 20px; box-sizing: border-box; transition: opacity 0.2s; }
        .p-btn { width: 62px; height: 62px; border: 2px solid #00ff41; border-radius: 50%; background: rgba(0,255,65,0.1); color: #00ff41; font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .p-btn:active { transform: scale(0.9); background: #00ff41; color: #000; }
        .prime-special { width: auto !important; padding: 0 20px; border-radius: 30px !important; border-color: #fff !important; color: #fff !important; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: auto; text-align: center; overflow-y: auto; padding: 20px 0; }
        .menu-btn { margin: 8px; padding: 15px; border: 1px solid #00ff41; background: none; color: #00ff41; width: 280px; font-size: 1rem; cursor: pointer; border-radius: 8px; }
        .menu-btn:hover { background: #00ff41; color: #000; }
        .hidden { display: none; }
        h1 { font-size: 2.5rem; text-shadow: 0 0 15px #00ff41; margin: 10px 0; }
        .rank-box { margin: 15px 0; padding: 10px; border: 1px solid #333; width: 250px; font-size: 0.9rem; color: #aaa; }
        .rank-title { color: #00ff41; margin-bottom: 5px; font-weight: bold; }
        #freeze-overlay { position: absolute; inset: 0; background: rgba(255,0,0,0.2); display: none; z-index: 5; pointer-events: none; }
    </style>
</head>
<body>

<div id="freeze-overlay"></div>

<div id="start-menu" class="overlay">
    <h1>PRIME CRUSH</h1>
    <div id="ranking-container"></div>
    <div style="margin-top: 10px;">
        <button class="menu-btn" onclick="gameStart('KINDERGARTEN', 15, [2,3,5])">KINDERGARTEN (2,3,5)</button>
        <button class="menu-btn" onclick="gameStart('CLERK', 50, [2,3,5,7,11])">CLERK (2-11)</button>
        <button class="menu-btn" onclick="gameStart('GENIUS', 100, [2,3,5,7,11,13,17,19])">GENIUS (2-19)</button>
    </div>
</div>

<div id="game-over" class="overlay hidden">
    <h1 style="color: #ff003c;">MISSION FAILED</h1>
    <p id="final-result" style="margin: 15px 0; font-size: 1.2rem;"></p>
    <div id="new-record" style="color: #ffcc00; font-weight: bold; margin-bottom: 15px;" class="hidden">NEW RECORD!</div>
    <button class="menu-btn" onclick="retry()">RETRY</button>
    <button class="menu-btn" onclick="goHome()">HOME</button>
</div>

<div id="game-ui" class="hidden">
    <div class="info-bar">
        <div>SCORE: <span id="score-val">0</span></div>
        <div id="life-display"></div>
    </div>
    <div id="input-panel"></div>
</div>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let score = 0, items = [], particles = [], isPlaying = false, canPress = true;
let diffMode, startLimit, currentPrimes, life, maxLife, spawnTimer = null;

const isP = (n) => {
    for(let i=2, s=Math.sqrt(n); i<=s; i++) if(n%i===0) return false;
    return n > 1;
};

function getRanking(mode) {
    const data = localStorage.getItem('pc_rank_' + mode);
    return data ? JSON.parse(data) : [];
}

function saveScore(mode, newScore) {
    if (newScore === 0) return false;
    let ranks = getRanking(mode);
    const isNewBest = ranks.length === 0 || newScore > ranks[0];
    ranks.push(newScore);
    ranks.sort((a, b) => b - a);
    ranks = ranks.slice(0, 5);
    localStorage.setItem('pc_rank_' + mode, JSON.stringify(ranks));
    return isNewBest;
}

function displayRanking() {
    const container = document.getElementById('ranking-container');
    const modes = ['KINDERGARTEN', 'CLERK', 'GENIUS'];
    container.innerHTML = '';
    modes.forEach(m => {
        const ranks = getRanking(m);
        const best = ranks.length > 0 ? ranks[0] : '-';
        container.innerHTML += `<div class="rank-box"><div class="rank-title">${m}</div>BEST: ${best}</div>`;
    });
}

function gameStart(mode, limit, primes) {
    if (spawnTimer) clearTimeout(spawnTimer);
    diffMode = mode;
    startLimit = limit;
    currentPrimes = primes;
    life = maxLife = (mode === 'KINDERGARTEN' ? 3 : (mode === 'CLERK' ? 2 : 1));

    document.getElementById('start-menu').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('new-record').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    
    const panel = document.getElementById('input-panel');
    panel.innerHTML = '';
    primes.forEach(p => {
        const b = document.createElement('div');
        b.className = 'p-btn'; b.innerText = p;
        b.addEventListener('touchstart', (e) => { e.preventDefault(); action(p); });
        b.addEventListener('mousedown', (e) => { e.preventDefault(); action(p); });
        panel.appendChild(b);
    });

    const pb = document.createElement('div');
    pb.className = 'p-btn prime-special'; pb.innerText = 'PRIME';
    pb.addEventListener('touchstart', (e) => { e.preventDefault(); action('IS_PRIME'); });
    pb.addEventListener('mousedown', (e) => { e.preventDefault(); action('IS_PRIME'); });
    panel.appendChild(pb);

    score = 0; updateUI();
    items = []; particles = []; isPlaying = true; canPress = true;
    spawn();
    requestAnimationFrame(tick);
}

function action(p) {
    if(!isPlaying || items.length === 0 || !canPress) return;
    const target = items.reduce((prev, curr) => (prev.y > curr.y) ? prev : curr);
    let correct = false;

    if (isP(target.v)) {
        if (p === 'IS_PRIME') { correct = true; target.dead = true; }
    } else {
        if (p !== 'IS_PRIME' && target.v % p === 0) {
            target.v /= p;
            if (target.v === 1) target.dead = true;
            correct = true;
        }
    }

    if (correct) {
        createExplosion(target.x, target.y, target.dead ? "#00ff41" : "#00bcff");
        score++; updateUI();
    } else {
        applyPenalty();
    }
}

function applyPenalty() {
    if (diffMode === 'KINDERGARTEN') {
        items.forEach(it => it.y += 40);
        return;
    }
    canPress = false;
    document.getElementById('input-panel').style.opacity = "0.2";
    document.getElementById('freeze-overlay').style.display = "block";
    setTimeout(() => {
        if (!isPlaying) return;
        canPress = true;
        document.getElementById('input-panel').style.opacity = "1";
        document.getElementById('freeze-overlay').style.display = "none";
    }, 800);
    reduceLife("MISCALCULATION");
}

function updateUI() {
    document.getElementById('score-val').innerText = score;
    document.getElementById('life-display').innerHTML = `<span style="color:#ff003c">${"‚ù§Ô∏è".repeat(life)}</span>${"üñ§".repeat(maxLife - life)}`;
}

function spawn() {
    if(!isPlaying) return;
    const levelBonus = Math.floor(score / 5) * 10;
    const currentMax = startLimit + levelBonus;
    items.push({
        v: Math.floor(Math.random() * (currentMax - 4)) + 4,
        x: Math.random() * (window.innerWidth - 100) + 50,
        y: -50, dead: false
    });
    let interval = Math.max(600, 3500 - (score * 50));
    spawnTimer = setTimeout(spawn, interval);
}

function reduceLife(reason) {
    life--; updateUI();
    if (life <= 0) gameOver(reason);
}

function gameOver(reason) {
    isPlaying = false;
    if (spawnTimer) clearTimeout(spawnTimer);
    const isNew = saveScore(diffMode, score);
    if (isNew) document.getElementById('new-record').classList.remove('hidden');
    document.getElementById('game-over').classList.remove('hidden');
    document.getElementById('final-result').innerText = `${reason}\nSCORE: ${score}`;
}

function retry() { gameStart(diffMode, startLimit, currentPrimes); }
function goHome() {
    isPlaying = false;
    if (spawnTimer) clearTimeout(spawnTimer);
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('game-ui').classList.add('hidden');
    document.getElementById('start-menu').classList.remove('hidden');
    displayRanking();
}

function createExplosion(x, y, color) {
    for(let i=0; i<12; i++) {
        particles.push({x, y, vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, life: 1.0, color});
    }
}

function tick() {
    if(!isPlaying) return;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.fillStyle = "rgba(0,0,0,0.4)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.05;
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 4, 4);
    });
    particles = particles.filter(p => p.life > 0);
    ctx.globalAlpha = 1.0;

    let target = items.length > 0 ? items.reduce((prev, curr) => (prev.y > curr.y) ? prev : curr) : null;
    items = items.filter(it => !it.dead);
    
    items.forEach(it => {
        let speed = (diffMode === 'GENIUS' ? 1.6 : (diffMode === 'CLERK' ? 1.1 : 0.8)) + (score/1500);
        it.y += speed;
        if(it.y > canvas.height - 220) {
            it.dead = true;
            reduceLife("LINE BREACH");
        }
        if (it === target) {
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 4;
            ctx.strokeRect(it.x - 55, it.y - 55, 110, 85);
            ctx.fillStyle = "#fff";
        } else {
            ctx.fillStyle = isP(it.v) ? "#00ff41" : "#00bcff";
        }
        ctx.font = "bold 44px 'JetBrains Mono'"; ctx.textAlign = "center";
        ctx.fillText(it.v, it.x, it.y);
    });
    requestAnimationFrame(tick);
}
displayRanking();
</script>
</body>
</html>
