<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PRIME CRUSH ELITE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; touch-action: none; overflow: hidden; }
        #game-ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .info-bar { position: absolute; top: 10px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; font-size: 1.2rem; }
        #input-panel { position: absolute; bottom: 80px; width: 100%; display: flex; justify-content: center; gap: 8px; pointer-events: auto; flex-wrap: wrap; padding: 0 10px; box-sizing: border-box; }
        .p-btn { width: 60px; height: 60px; border: 2px solid #00ff41; border-radius: 50%; background: rgba(0,255,65,0.1); color: #00ff41; font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .p-btn:active { transform: scale(0.9); background: #00ff41; color: #000; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: auto; text-align: center; }
        .menu-btn { margin: 10px; padding: 15px; border: 1px solid #00ff41; background: none; color: #00ff41; width: 280px; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .menu-btn:hover { background: #00ff41; color: #000; }
        .hidden { display: none; }
        h1 { font-size: 3rem; text-shadow: 0 0 15px #00ff41; margin: 0; }
        .life-heart { color: #ff003c; text-shadow: 0 0 5px #ff003c; }
    </style>
</head>
<body>

<div id="start-menu" class="overlay">
    <h1>PRIME CRUSH</h1>
    <p style="letter-spacing: 2px;">ELITE MATHEMATICS UNIT</p>
    <div style="margin-top: 20px;">
        <button class="menu-btn" onclick="gameStart(20, [2,3,5])">KINDERGARTEN („É©„Ç§„Éï3 / ÊøÄÁ™ÅÊ≥®ÊÑè)</button>
        <button class="menu-btn" onclick="gameStart(100, [2,3,5,7,11])">CLERK („É©„Ç§„Éï2 / Ë®àÁÆó„Éü„ÇπNG)</button>
        <button class="menu-btn" onclick="gameStart(999, [2,3,5,7,11,13,17,19])">GENIUS („É©„Ç§„Éï1 / Âç≥Ê≠ª)</button>
    </div>
</div>

<div id="game-over" class="overlay hidden">
    <h1 style="color: #ff003c;">MISSION FAILED</h1>
    <p id="final-result" style="margin: 20px 0; font-size: 1.2rem;"></p>
    <button class="menu-btn" onclick="retry()">RETRY („ÇÇ„ÅÜ„ÅÑ„Å°„Å©)</button>
    <button class="menu-btn" onclick="goHome()">HOME (Èõ£ÊòìÂ∫¶ÈÅ∏Êäû)</button>
</div>

<div id="game-ui" class="hidden">
    <div class="info-bar">
        <div>SCORE: <span id="score-val">2</span></div>
        <div id="life-display"></div>
    </div>
    <div id="input-panel"></div>
</div>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let score = 2, items = [], particles = [], isPlaying = false;
let diffLimit, currentPrimes, life, maxLife, spawnTimer;

const isP = (n) => {
    for(let i=2, s=Math.sqrt(n); i<=s; i++) if(n%i===0) return false;
    return n > 1;
};

function gameStart(limit, primes) {
    diffLimit = limit;
    currentPrimes = primes;
    // „É©„Ç§„ÉïË®≠ÂÆö
    if (limit <= 20) { life = maxLife = 3; }
    else if (limit <= 100) { life = maxLife = 2; }
    else { life = maxLife = 1; }

    document.getElementById('start-menu').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    
    const panel = document.getElementById('input-panel');
    panel.innerHTML = '';
    primes.forEach(p => {
        const b = document.createElement('div');
        b.className = 'p-btn'; b.innerText = p;
        b.onmousedown = (e) => { e.preventDefault(); action(p); };
        b.ontouchstart = (e) => { e.preventDefault(); action(p); };
        panel.appendChild(b);
    });

    score = 2;
    updateUI();
    items = []; particles = [];
    isPlaying = true;
    spawn();
    tick();
}

function updateUI() {
    document.getElementById('score-val').innerText = score;
    document.getElementById('life-display').innerHTML = 
        `<span class="life-heart">${"‚ù§Ô∏è".repeat(life)}</span>${"üñ§".repeat(maxLife - life)}`;
}

function action(p) {
    if(!isPlaying || items.length === 0) return;
    const target = items.reduce((prev, curr) => (prev.y > curr.y) ? prev : curr);

    if (target.v % p === 0) {
        target.v /= p;
        createExplosion(target.x, target.y, "#00bcff");
        if (target.v === 1) {
            target.dead = true;
            createExplosion(target.x, target.y, "#00ff41");
        }
        let next = score + 1;
        while(!isP(next)) next++;
        score = next;
        updateUI();
    } else if (diffLimit > 20) {
        reduceLife("Ë®àÁÆó„Éü„ÇπÔºÅ");
    }
}

function reduceLife(reason) {
    life--;
    updateUI();
    createExplosion(window.innerWidth/2, window.innerHeight/2, "#ff003c");
    if (life <= 0) gameOver(reason);
}

function spawn() {
    if(!isPlaying) return;
    items.push({
        v: Math.floor(Math.random() * (diffLimit - 5)) + 5,
        x: Math.random() * (window.innerWidth - 60) + 30,
        y: -50, dead: false
    });
    spawnTimer = setTimeout(spawn, Math.max(700, 3500 - score/4));
}

function gameOver(reason) {
    isPlaying = false;
    clearTimeout(spawnTimer);
    document.getElementById('game-over').classList.remove('hidden');
    document.getElementById('final-result').innerText = `${reason}\nSCORE: ${score}`;
}

function retry() { gameStart(diffLimit, currentPrimes); }
function goHome() {
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('game-ui').classList.add('hidden');
    document.getElementById('start-menu').classList.remove('hidden');
    isPlaying = false;
}

function createExplosion(x, y, color) {
    for(let i=0; i<12; i++) {
        particles.push({x, y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 1.0, color});
    }
}

function tick() {
    if(!isPlaying) return;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.fillStyle = "rgba(0,0,0,0.4)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.04;
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
        ctx.fillRect(p.x, p.y, 5, 5);
    });
    ctx.globalAlpha = 1.0;
    particles = particles.filter(p => p.life > 0);

    let target = items.length > 0 ? items.reduce((prev, curr) => (prev.y > curr.y) ? prev : curr) : null;

    items = items.filter(it => !it.dead);
    items.forEach(it => {
        it.y += 0.8 + (score/2500);
        if(it.y > canvas.height - 180) {
            it.dead = true;
            reduceLife("Ë¶ãÈÄÉ„Åó„Éü„ÇπÔºÅ");
        }
        if (it === target) {
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 4;
            ctx.strokeRect(it.x - 40, it.y - 45, 80, 65);
            ctx.fillStyle = "#fff";
        } else {
            ctx.fillStyle = isP(it.v) ? "#00ff41" : "#00bcff";
        }
        ctx.font = "bold 42px 'JetBrains Mono'"; ctx.textAlign = "center";
        ctx.fillText(it.v, it.x, it.y);
    });
    requestAnimationFrame(tick);
}
</script>
</body>
</html>
